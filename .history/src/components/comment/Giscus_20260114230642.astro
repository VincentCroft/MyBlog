---
import { commentConfig } from "@/config";

if (!commentConfig || !commentConfig.giscus) {
	throw new Error("Giscus comments are not configured");
}

const giscus = commentConfig.giscus;
// 可自定义主题名称（内置：light|dark|preferred_color_scheme|transparent_dark|noborder_* 等）
// 也可配合自定义样式表（theme-url）使用第三方主题，如 catppuccin
// 示例：
//   const lightTheme = "light";
//   const lightThemeUrl = "https://giscus.catppuccin.com/themes/latte.css";
//   const darkTheme = "dark";
//   const darkThemeUrl = "https://giscus.catppuccin.com/themes/mocha.css";
const lightTheme = "light";
const darkTheme = "dark";
const lightThemeUrl: string | undefined = undefined;
const darkThemeUrl: string | undefined = undefined;
---

<script is:inline type="module" src="https://esm.sh/giscus"></script>

<!-- 
  Giscus 官方Web Component用法，兼容Astro静态输出，无需import包，无需NPM依赖！
  参考：https://giscus.app/ 详情配置说明
-->
<giscus-widget
  id="comments"
  repo={giscus.repo}
  repoId={giscus.repoId}
  category={giscus.category}
  categoryId={giscus.categoryId}
  mapping={giscus.mapping}
  strict={giscus.strict}
  reactionsEnabled={giscus.reactionsEnabled}
  emitMetadata={giscus.emitMetadata}
  inputPosition={giscus.inputPosition}
  theme={lightTheme}
  {...(lightThemeUrl ? { "theme-url": lightThemeUrl } : {})}
  lang={giscus.lang}
  loading={giscus.loading}
/>

<script is:inline define:vars={{ lightTheme, darkTheme, lightThemeUrl, darkThemeUrl }}>
  function updateGiscusTheme() {
    // 优先读取站点 data-theme，兼容 class="dark" 与系统配色
    const dataTheme = document.documentElement.getAttribute('data-theme');
    const isDark = dataTheme ? dataTheme === 'dark' : (document.documentElement.classList.contains('dark') || window.matchMedia?.('(prefers-color-scheme: dark)').matches);
    const theme = isDark ? darkTheme : lightTheme;
    const themeUrl = isDark ? darkThemeUrl : lightThemeUrl;
    const widget = document.querySelector('giscus-widget');
    if (widget) {
      widget.setAttribute('theme', theme);
      if (themeUrl) {
        widget.setAttribute('theme-url', themeUrl);
      } else {
        widget.removeAttribute('theme-url');
      }
    }
  }

  // Initial update
  updateGiscusTheme();

  // Clean up previous observer if exists
  if (window.giscusThemeObserver) {
    window.giscusThemeObserver.disconnect();
  }

  // Create new observer
  window.giscusThemeObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && (mutation.attributeName === 'class' || mutation.attributeName === 'data-theme')) {
        updateGiscusTheme();
      }
    });
  });

  window.giscusThemeObserver.observe(document.documentElement, { attributes: true });
</script>
